> [!IMPORTANT]
> 本文档尚在施工中

# 协议实现者指南

本文档是为需要基于 Laana 协议本身进行开发（例如，编写适配某种语言的 Laana SDK 或为某种应用端框架编写适配器）的开发者准备的。如果你是一个聊天机器人开发者，你不应该阅读本文档，而应当专注于应用端框架（例如 ~~NoneBot~~、~~Koishi~~ ←针对这俩框架的适配器还没写 ）的文档。

## 术语表

- **Laana**: 聊天机器人开发协议。
- **Uin**: 所谓的 QQ 号，无符号 32 位整数，但在 QQNT 内部实现中多以字符串形式传递。
- **Uid**: QQNT 内部另一套更加常用的用户标识，为遵循一定格式的字符串。
- **User**: 用户，包括陌生人、好友和群成员。
- **Buddy**: 好友。选用此词是因为该词在 QQNT 内部的代码中被广泛使用。
- **Message**: 消息。一条“消息”是指出现在聊天框中的最小不可分单位，可以是文本消息、图文混排消息、图片消息、语音消息、视频消息、文件消息等。
- **Bubble**: 气泡。用以代指纯文本或图文混排消息，与图片、语音、视频、文件等消息**并列**。
- **Segment**: 消息段。指气泡消息中的最小不可分单位，可以是纯文本、表情、图片和 At（“提到”某人）。这一点与 OneBot 11 标准有很大不同，因为 OneBot 11 中的消息段还可以是语音、视频、文件等，这给消息处理带来了很大的复杂性。实际上 QQ 中的图文消息中是不可能包含语音、视频、文件等的。
- **Event**: 事件，指外界变化对 Bot 造成的影响。事件可以是消息事件、好友事件、群事件等。
- **Action**: 动作，指 Bot 的拉取信息、响应事件等行为，与常规编程中的“函数”类似。动作可以是发送消息、获取好友列表、获取群列表等。
- **Ping**: 执行一个动作所要发送的信息，与常规编程中的“参数”类似。
- **Pong**: 执行一个动作后返回的信息，与常规编程中的“返回值”类似。

## 协议标准

见根目录下的 `proto` 文件夹。协议制定时，尽量在各个字段的命名中包含了足够的关键词以使开发者能够理解其含义；对于一些特殊的字段，也在注释中进行了解释。

### 文件缓存

Laana 对协议端的文件缓存实现要求**所有**文件都对应一个 `cacheId`。用户上传文件可以选择提供文件的字节数据，也可以选择提供文件的 URL。协议端应当以相应方式获取文件的字节数据，并将其缓存到本地，返回一个 `cacheId`。之后，用户可以通过 `cacheId` 获取文件的字节数据，或直接在后续的调用中使用 `cacheId` 代替文件的字节数据或 URL。而对于 QQ 远程传来的文件，协议端应当在接收到文件时提供一个 `cacheId`，但并不一定需要缓存文件的字节数据，但需要保证在需要时能够获取到文件的字节数据。

### 可持久化字段

Laana 协议的设计中，对于一些字段，我们需要考虑其是否应当是可持久化（储存）的。 **能否持久化的标准在于，如果在不同的协议端之间，这个字段的值是相同的，那么这个字段就可以持久化。** 目前，能够确认安全持久化的字段只有 `Uin` 一个，因为它们在不同的协议端之间有共同的标准，也就是用户的 QQ 号。对于其他字段，例如 `msgId` 和 `cacheId`，不同的实现端可能有不同的生成规则，因此不应当持久化。字段不能持久化并不代表它们没有意义，而是因为它们的意义在不同的协议端之间可能不同，因此不应当在持久化时假设其意义。它们仍然可以在运行时使用。

## 网络通信

### WebSocket

为方便快速开发，目前唯一的通信方式是 WebSocket 协议。由协议实现端提供 WebSocket 服务器，由应用端框架提供 WebSocket 客户端。客户端首先发送一个 `ClientSideHandshake` 消息，其中携带协议端版本和 `token`（可选）；服务器核对版本和 `token`，返回一个 `ServerSideHandshake` 消息，之后双方开始正式通信。

> [!NOTE]
> 目前正在考虑研究基于裸 TCP 的通信方式（不同于 gRPC），以提高通信效率。